<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@abazlinton" />
  <meta name="twitter:title" content="Sunset Generator" />
  <meta name="twitter:description" content="Generate 'realistic' looking sunsets" />
  <meta name="twitter:image" content="https://sunset-delta.vercel.app/sunset.png" />
  <title>Sunset Generator</title>
  <script src="terrain.js"></script>
  <script>
    function reload() {
      document.querySelector('body').innerHTML = ''
      location.reload()
    }  
  </script>
</head>

<body>
  <h1
    style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;"
    onclick="reload()">
    Please Wait...</h1>
  <!-- <canvas onclick="redraw()" id="canvas" width="1200" height="1200"></canvas> -->

</body>
<script type="module">

  import * as THREE from 'https://unpkg.com/three/build/three.module.js';

  const terrainPallette = [
    '#FFFFFF',
    '#9C6608',
    '#885916',
    '#734C23',
    '#5F3E31',
    '#4A313E',
    '#485E2D',
    '#506C2D',
    '#4E7321',
    '#517A33',
    '#141E8B',
    '#0F1986',
  ]
  const sunset = new THREE.Color(0xFF7433);
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 100);

  const renderer = new THREE.WebGLRenderer();
  let width = window.innerWidth
  if (width >= 900) {
    width = 800
  } else {
    width *= 0.9
  }
  renderer.setSize(width, width);
  document.body.appendChild(renderer.domElement);

  camera.position.x = 64
  camera.position.z = 64
  camera.position.y = 12
  const materials = {}
  const boxGeometries = {}

  camera.lookAt(new THREE.Vector3(16, 0, 16))
  function setup() {

    const terrain = new Terrain()
    const power = 7
    const size = 2 ** power
    terrain.init(size + 1)
    terrain.set(0, 0, -10)
    terrain.set(0, size, -10)
    terrain.set(size, size, -10)
    terrain.set(size, 0, -10)
    terrain.run(size + 1)
    const allHeights = terrain.grid.flat()
    const max = allHeights.reduce((highest, current) => current > highest ? current : highest)
    const min = allHeights.reduce((lowest, current) => current < lowest ? current : lowest)
    terrain.grid.forEach((col, y) => col.forEach((cell, x) => {
      const gradient = cell / max * 256
      let gradientIndex = Math.floor(terrainPallette.length - cell / max * terrainPallette.length)
      if (gradientIndex < 0) gradientIndex = 0
      if (gradientIndex >= terrainPallette.length) gradientIndex = terrainPallette.length - 1
      const height = ((1 - (gradientIndex / terrainPallette.length)) * 8)

      let boxGeometry
      if (boxGeometries[height]) {
        boxGeometry = boxGeometries[height]
      } else {
        boxGeometry = new THREE.BoxGeometry(1, height, 1)
        boxGeometries[height] = boxGeometry
      }

      const rgb = terrainPallette[gradientIndex]

      let material
      if (materials[rgb]) {
        material = materials[rgb]
      } else {
        material = new THREE.MeshBasicMaterial({
          color: rgb
        });
        materials[rgb] = material
      }
      const column = new THREE.Mesh(boxGeometry, material)
      column.translateX(x)
      column.translateZ(y)
      column.translateY(0.9 * height)
      scene.add(column);
      scene.background = sunset
    }))

    document.querySelector('h1').innerText = ''
    renderer.render(scene, camera);
  }
  setup();

  let frameCount = 0
  let g = 150

  const animate = function () {

    if (camera.position.y < 20) {
      frameCount++
      camera.translateZ(0.10)
      camera.translateX(-0.04)

      g = 150 - (frameCount / 781) * 75
      const sunset = new THREE.Color(`rgb(255, ${Math.floor(g)}, 51)`);
      scene.fog = new THREE.Fog(sunset, 0, 100);
      scene.background = sunset
      setTimeout(function () {

        requestAnimationFrame(animate);

      }, 1000 / 30);
    } else {
      document.querySelector('h1').innerText = 'Click here to regenerate'
    }
    renderer.render(scene, camera);
  };
  animate()

  // redraw()
  // function redraw() {
  //   const canvas = document.getElementById('canvas');
  //   const ctx = canvas.getContext('2d');

  // }

</script>

</html>